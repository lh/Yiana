# Address Extraction System for Yiana

## Overview
This system extracts UK addresses, names, and dates of birth from OCR output generated by the Yiana app. It uses multiple extraction methods to maximize accuracy.

## Components

### 1. Core Extractor (`address_extractor.py`)
- Pattern-based extraction using regex
- Three extraction methods:
  - **Form-based**: Extracts from structured forms with field labels
  - **Label-based**: Extracts from address label formats
  - **Unstructured**: Falls back to pattern matching
- SQLite database storage for extracted data
- UK postcode validation

### 2. Spire Healthcare Form Extractor (`spire_form_extractor.py`)
- Specialized extractor for Spire Healthcare Registration Forms
- High confidence extraction (0.9) for these specific forms
- Handles variations in form layout between different documents

### 3. LLM-Enhanced Extraction (`llm_extractor.py`)
- Uses Ollama for local LLM processing
- Supports models: qwen2.5:3b, mistral:7b, llama3.2:3b
- Hybrid approach combining pattern and LLM extraction
- Falls back to pattern matching if LLM unavailable

### 4. Extraction Service (`extraction_service.py`)
- Watches OCR output directory for new files
- Automatically processes new OCR results
- Query interface for searching extracted addresses

### 5. Test Suite (`test_extraction.py`)
- Tests extraction on specific files
- Compares pattern vs LLM extraction methods
- Validates postcode formats

## Installation

```bash
# Clone or navigate to the AddressExtractor directory
cd /Users/rose/Code/Yiana/AddressExtractor

# Run setup
./setup.sh

# Or manually:
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## Usage

### Command Line Testing
```bash
# Test specific OCR file
python test_extraction.py --file /path/to/ocr.json

# Test all Address files
python test_extraction.py

# Compare extraction methods
python test_extraction.py --compare /path/to/ocr.json
```

### Running the Service
```bash
# Start watching for new OCR files
python extraction_service.py

# Process existing files only
python extraction_service.py --no-watch

# Use LLM enhancement
python extraction_service.py --use-llm

# Query extracted addresses
python extraction_service.py --query
```

### Direct Extraction
```bash
# Extract from OCR JSON
python address_extractor.py /path/to/ocr.json document_id
```

## Database Schema
Extracted addresses are stored in SQLite (`addresses.db`):

```sql
CREATE TABLE extracted_addresses (
    id INTEGER PRIMARY KEY,
    document_id TEXT NOT NULL,
    page_number INTEGER,
    full_name TEXT,
    date_of_birth TEXT,
    address_line_1 TEXT,
    address_line_2 TEXT,
    city TEXT,
    county TEXT,
    postcode TEXT,
    country TEXT DEFAULT 'UK',
    extraction_confidence REAL,
    extraction_method TEXT,
    extracted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    postcode_valid BOOLEAN,
    postcode_district TEXT,
    raw_text TEXT,
    ocr_json TEXT
)
```

## Extraction Methods

### Priority Order
1. **Spire Healthcare Form** (confidence: 0.9) - Specialized for Spire forms
2. **Form-based** (confidence: 0.8) - Structured forms with labels
3. **Label-based** (confidence: 0.7) - Address label format
4. **Unstructured** (confidence: 0.5) - Pattern matching fallback
5. **LLM** (confidence: variable) - Used when pattern matching fails

### Known Patterns
- UK Postcodes: `[A-Z]{1,2}[0-9][0-9A-Z]? [0-9][A-Z]{2}`
- Date formats: `DD/MM/YYYY`, `DD.MM.YYYY`, `DD-MM-YYYY`
- Name patterns: Title + First + Last, "Surname, Firstname"

## Test Results

### Spire Healthcare Forms
Successfully extracts from Spire Healthcare Registration Forms:
- **Address1**: Piper, Elizabeth Helenah (DOB: 07.10.1933, RH10 4HD) ✅
- **Address2**: Chilvers, Linda (DOB: 03.10.1949, RH6 9EP) ✅
- **Address3**: Hitchcock, Peter (DOB not in OCR*, RH13 8JT) ⚠️

*Note: Address3 DOB visible in PDF but missing from OCR output - OCR quality issue

## LLM Setup (Optional)

For enhanced extraction with local LLM:

1. Install Ollama from https://ollama.ai
2. Pull a model:
   ```bash
   ollama pull qwen2.5:3b  # Recommended - fast and efficient
   ollama pull mistral:7b  # Alternative - more accurate
   ```

## Troubleshooting

### Common Issues
1. **No extraction**: Check if text contains expected patterns
2. **Wrong extraction**: May need specialized extractor for form type
3. **LLM timeout**: Reduce text length or use smaller model
4. **OCR quality**: Some fields may not be captured by OCR

### Debug Mode
```python
# Enable logging
import logging
logging.basicConfig(level=logging.DEBUG)
```

## Future Enhancements
- [ ] Support for more form types
- [ ] Postcode validation using free UK government APIs
- [ ] Confidence scoring improvements
- [ ] Batch processing optimization
- [ ] Web interface for manual corrections